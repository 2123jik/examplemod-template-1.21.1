aces_spell_utils:evasive                           |闪避         
aces_spell_utils:goliath_slayer                    |巨人杀手        
aces_spell_utils:hunger_steal                      |饥饿偷取      
aces_spell_utils:mana_rend                         |法力撕裂        
aces_spell_utils:mana_steal                        |法力偷取      
aces_spell_utils:spell_res_penetration             |法术穿透
apothic_attributes:armor_pierce                    | 盔甲穿透    -盔甲           
apothic_attributes:armor_shred                     | 盔甲撕裂            
apothic_attributes:arrow_damage                    | 箭矢伤害               
apothic_attributes:arrow_velocity                  | 箭矢速度               
apothic_attributes:cold_damage                     | 冰霜伤害               
apothic_attributes:crit_chance                     | 暴击率                
apothic_attributes:crit_damage                     | 暴击伤害               
apothic_attributes:current_hp_damage               | 当前生命值伤害            
apothic_attributes:dodge_chance                    | 闪避率                
apothic_attributes:draw_speed                      | 蓄力速度       可以小于1        
apothic_attributes:elytra_flight                   | 鞘翅飞行               
apothic_attributes:experience_gained               | 经验获取               
apothic_attributes:fire_damage                     | 火焰伤害               
apothic_attributes:ghost_health                    | 虚假生命               
apothic_attributes:healing_received                | 受到治疗               
apothic_attributes:life_steal                      | 生命偷取               
apothic_attributes:mining_speed                    | 挖掘速度               
apothic_attributes:overheal                        | 过量治疗               
apothic_attributes:projectile_damage               | 弹射物伤害              
apothic_attributes:prot_pierce                     | 保护穿透               
apothic_attributes:prot_shred                      | 保护撕裂               
artifacts:generic.attack_burning_duration          | 攻击燃烧的持续时间          
artifacts:generic.drinking_speed                   | 饮用速度               
artifacts:generic.eating_speed                     | 食用速度               
artifacts:generic.flatulence                       | 胀气                 
artifacts:generic.invincibility_ticks              | 无敌刻                
artifacts:generic.mount_speed                      | 骑乘速度               
artifacts:generic.movement_speed_on_snow           | 雪上移动速度             
artifacts:generic.slip_resistance                  | 光滑抗性               
artifacts:generic.sprinting_speed                  | 疾跑速度               
artifacts:generic.sprinting_step_height            | 疾跑时跨越高度            
artifacts:player.entity_experience                 | 实体经验获得倍率           
artifacts:player.villager_reputation               | 村民声望                
gtbcs_geomancy_plus:geo_magic_resist               | 岩土法术抗性             
gtbcs_geomancy_plus:geo_spell_power                | 岩土法术效能             
irons_spellbooks:blood_magic_resist                | 猩红法术抗性             
irons_spellbooks:blood_spell_power                 | 猩红法术强度             
irons_spellbooks:cast_time_reduction               | 法术吟唱缩减             
irons_spellbooks:casting_movespeed                 | 施法时移动速度            
irons_spellbooks:cooldown_reduction                | 法术冷却缩减             
irons_spellbooks:eldritch_magic_resist             | 邪术抗性               
irons_spellbooks:eldritch_spell_power              | 邪术强度               
irons_spellbooks:ender_magic_resist                | 末影法术抗性             
irons_spellbooks:ender_spell_power                 | 末影法术强度             
irons_spellbooks:evocation_magic_resist            | 唤魔法术抗性             
irons_spellbooks:evocation_spell_power             | 唤魔法术强度             
irons_spellbooks:fire_magic_resist                 | 炽焰法术抗性             
irons_spellbooks:fire_spell_power                  | 炽焰法术强度             
irons_spellbooks:holy_magic_resist                 | 神圣法术抗性             
irons_spellbooks:holy_spell_power                  | 神圣法术强度             
irons_spellbooks:ice_magic_resist                  | 冰霜法术抗性             
irons_spellbooks:ice_spell_power                   | 冰霜法术强度             
irons_spellbooks:lightning_magic_resist            | 雷霆法术抗性             
irons_spellbooks:lightning_spell_power             | 雷霆法术强度             
irons_spellbooks:mana_regen                        | 法力值恢复              
irons_spellbooks:max_mana                          | 最大法力值              
irons_spellbooks:nature_magic_resist               | 自然法术抗性             
irons_spellbooks:nature_spell_power                | 自然法术强度             
irons_spellbooks:spell_power                       | 法术强度               
irons_spellbooks:spell_resist                      | 法术抗性               
irons_spellbooks:summon_damage                     | 召唤伤害               
iss_magicfromtheeast:dune_magic_resist             | 沙丘法术抗性             
iss_magicfromtheeast:dune_spell_power              | 沙丘法术强度             
iss_magicfromtheeast:spirit_magic_resist           | 魂灵法术抗性             
iss_magicfromtheeast:spirit_spell_power            | 魂灵法术强度             
iss_magicfromtheeast:symmetry_magic_resist         | 两仪法术抗性             
iss_magicfromtheeast:symmetry_spell_power          | 两仪法术强度             
l2damagetracker:bow_strength                       | 投射物伤害              
l2damagetracker:crit_damage                        | 暴击伤害               
l2damagetracker:crit_rate                          | 暴击率                
l2damagetracker:damage_absorption                  | 伤害吸收               
l2damagetracker:damage_reduction                   | 受到的伤害              
l2damagetracker:explosion_damage                   | 爆炸伤害               
l2damagetracker:fire_damage                        | 火焰伤害               
l2damagetracker:freezing_damage                    | 冻结伤害               
l2damagetracker:lightning_damage                   | 雷电伤害               
l2damagetracker:magic_damage                       | 魔法伤害               
l2damagetracker:regen                              | 再生效率               
l2hostility:extra_difficulty                       | 额外难度               
l2weaponry:reflect_time                            | 盾反时间               
l2weaponry:shield_defense                          | 盾值          -主动举盾       
modulargolems:golem_jump                           | 傀儡跳跃               
modulargolems:golem_regen                          | 生命回复               
modulargolems:golem_size                           | 傀儡体型               
modulargolems:golem_sweep                          | 范围攻击      -决定了基础攻击是否会命中目标周围的额外实体         
neoforge:creative_flight                           |创造飞行
neoforge:nametag_distance                          |名称标签可见距离
neoforge:swim_speed                                |游泳速度
minecraft:generic.armor                            |护甲值
minecraft:generic.armor_toughness                  |盔甲韧性
minecraft:generic.attack_damage                    |攻击伤害
minecraft:generic.attack_knockback                 |击退
minecraft:generic.attack_speed                     |攻击速度
minecraft:generic.burning_time                     |着火时间
minecraft:generic.explosion_knockback_resistance   |爆炸击退抗性
minecraft:generic.fall_damage_multiplier           |摔落伤害倍数
minecraft:generic.gravity                          |重力
minecraft:generic.jump_strength                    |跳跃力度
minecraft:generic.knockback_resistance             |击退抗性
minecraft:generic.luck                             |幸运值
minecraft:generic.max_absorption                   |最大伤害吸收值
minecraft:generic.max_health                       |最大生命值
minecraft:generic.movement_efficiency              |移动效率
minecraft:generic.movement_speed                   |速度
minecraft:generic.oxygen_bonus                     |额外氧气
minecraft:generic.safe_fall_distance               |安全摔落高度
minecraft:generic.scale                            |尺寸
minecraft:generic.step_height                      |最大行走高度
minecraft:generic.water_movement_efficiency        |水中移动效率
minecraft:player.block_break_speed                 |方块破坏速度
minecraft:player.block_interaction_range           |方块交互距离
minecraft:player.entity_interaction_range          |实体交互距离
minecraft:player.mining_efficiency                 |挖掘效率
minecraft:player.sneaking_speed                    |潜行速度
minecraft:player.submerged_mining_speed            |水下挖掘速度
minecraft:player.sweeping_damage_ratio             |横扫伤害比率
minecraft:generic.flying_speed                     |生物飞行速度
minecraft:generic.follow_range                     |生物跟随距离

这是一份针对开发者视角的 **Apothic Attributes** 机制技术文档。基于你提供的源码（`AttributeEvents.java` 和 `Attributes` 定义），整理了属性的具体实现逻辑、事件优先级、计算公式以及特殊的 NBT/Data 处理。

---

# Apothic Attributes 机制与实现细节 (Developer Wiki)

本文档基于 `dev.shadowsoffire.apothic_attributes` 包下的源码分析，旨在解释各项属性在 NeoForge 事件总线上的具体挂钩方式及运算逻辑。

## 1. 属性定义概览 (Registry)

所有属性注册于 `apothic_attributes` 命名空间下。

| 属性名称 (Field) | ID | Base | Range | 类型 | 备注 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **ARMOR_PIERCE** | `armor_pierce` | 0.0 | 0 ~ 1000 | Ranged | 固定护甲穿透 (源码中未体现计算逻辑，通常在 Mixin 中) |
| **ARMOR_SHRED** | `armor_shred` | 0.0 | 0 ~ 2.0 | % | 百分比护甲削减 (源码中未体现计算逻辑) |
| **ARROW_DAMAGE** | `arrow_damage` | 1.0 | 0 ~ 10.0 | % | 远程伤害倍率 |
| **ARROW_VELOCITY** | `arrow_velocity` | 1.0 | 0 ~ 10.0 | % | 箭矢速度倍率 |
| **COLD_DAMAGE** | `cold_damage` | 0.0 | 0 ~ 1000 | Ranged | 附带冰霜魔法伤害 |
| **CRIT_CHANCE** | `crit_chance` | 0.05 | 0 ~ 10.0 | % | 暴击几率 (支持过量暴击) |
| **CRIT_DAMAGE** | `crit_damage` | 1.5 | 1 ~ 100 | % | 暴击伤害倍率 |
| **CURRENT_HP_DAMAGE**| `current_hp_damage`| 0.0 | 0 ~ 1.0 | % | 基于目标当前生命的额外物理伤害 |
| **DODGE_CHANCE** | `dodge_chance` | 0.0 | 0 ~ 1.0 | % | 闪避几率 |
| **DRAW_SPEED** | `draw_speed` | 1.0 | 0 ~ 4.0 | % | 拉弓/蓄力速度 |
| **EXPERIENCE_GAINED**| `experience_gained`| 1.0 | 0 ~ 1000 | % | 经验获取倍率 |
| **FIRE_DAMAGE** | `fire_damage` | 0.0 | 0 ~ 1000 | Ranged | 附带火焰魔法伤害 |
| **GHOST_HEALTH** | `ghost_health` | 0.0 | 0 ~ 1000 | Ranged | *源码事件中未直接使用，可能涉及生命回复逻辑* |
| **HEALING_RECEIVED** | `healing_received` | 1.0 | 0 ~ 1000 | % | 治疗接受率 |
| **LIFE_STEAL** | `life_steal` | 0.0 | 0 ~ 10.0 | % | 生命偷取 |
| **MINING_SPEED** | `mining_speed` | 1.0 | 0 ~ 10.0 | % | 挖掘速度 |
| **OVERHEAL** | `overheal` | 0.0 | 0 ~ 10.0 | % | 过量治疗 (转化为伤害吸收) |
| **PROJECTILE_DAMAGE**| `projectile_damage`| 1.0 | 0 ~ 10.0 | % | 接收到的投射物伤害修正 |
| **PROT_PIERCE** | `prot_pierce` | 0.0 | 0 ~ 34.0 | Ranged | 固定保护穿透 (源码中未体现，通常在 Mixin) |
| **PROT_SHRED** | `prot_shred` | 0.0 | 0 ~ 1.0 | % | 百分比保护削减 (源码中未体现) |
| **ELYTRA_FLIGHT** | `elytra_flight` | false | bool | Bool | 是否允许鞘翅飞行 |

---

## 2. 攻击与伤害机制 (Offensive Mechanics)

### 2.1 暴击系统 (Apothic Crits)
**事件**: `LivingIncomingDamageEvent` (Priority: HIGH)
**方法**: `apothCriticalStrike`

Apothic Attributes 实现了一套独立于原版跳劈暴击的**过量暴击 (Overcrit)** 机制。

*   **触发条件**: 攻击者是 `LivingEntity` 且没有 `apothic_attributes:cannot_critically_strike` 标签。
*   **计算逻辑**:
    这是一个 `while` 循环，只要随机数满足且暴击倍率仍有效，就会持续叠加伤害。
    1.  **初始状态**: `chance = CRIT_CHANCE`, `critDmg = CRIT_DAMAGE`, `damage = original_damage`。
    2.  **循环判定**: `rand.nextFloat() <= chance` 且 `critDmg > 1.0`。
    3.  **单次暴击增益**:
        ```java
        damage += original_damage * (critDmg - 1);
        ```
    4.  **属性衰减 (Diminishing Returns)**:
        *   `chance` 减 1 (即消耗掉 100% 的几率)。
        *   `critDmg` 乘以 `0.85` (每次额外暴击的效果只有上一次的 85%)。
*   **网络同步**: 若触发暴击，向周围玩家发送 `CritParticlePayload` 播放粒子效果。
*   **原版兼容**: 在 `CriticalHitEvent` 中，如果发生原版暴击，伤害倍率取 `max(vanillaMult, CRIT_DAMAGE)`。

### 2.2 附带魔法伤害 (Auxiliary Damage)
**事件**: `LivingIncomingDamageEvent` (Priority: LOWEST)
**方法**: `meleeDamageAttributes`

在物理伤害结算前，通过 `AuxDmgTracker` 施加额外的魔法伤害。为防止递归死循环，使用了 `noRecurse` 静态锁。

1.  **当前生命值伤害 (`CURRENT_HP_DAMAGE`)**:
    *   类型: `apothic_attributes:current_hp_damage`
    *   公式: `Damage = target.getHealth() * CURRENT_HP_DAMAGE`
2.  **火焰伤害 (`FIRE_DAMAGE`)**:
    *   类型: `apothic_attributes:fire_damage`
    *   公式: `Damage = FIRE_DAMAGE`
    *   **特效**: 增加目标燃烧时间 `ticks = 10 * Damage`。
3.  **冰霜伤害 (`COLD_DAMAGE`)**:
    *   类型: `apothic_attributes:cold_damage`
    *   公式: `Damage = COLD_DAMAGE`
    *   **特效**: 施加缓慢效果 (Effect: `MOVEMENT_SLOWDOWN`)。
        *   时长: `min(150, 15 * Damage)` ticks。
        *   等级: `log2(Damage / 5)`。

**特殊处理**: 如果 Aux 伤害杀死了目标，会在目标数据中标记 `apoth.killed_by_aux_dmg` 并取消当前的 `LivingIncomingDamageEvent`，以防止原版伤害逻辑对已死实体再次调用 `die()`。

### 2.3 远程武器属性
**事件**: `EntityJoinLevelEvent`
**方法**: `arrow`

当 `AbstractArrow` 加入世界时触发一次（通过 `apothic_attributes.arrow.done` 标签防止重复）：
*   **伤害**: `ArrowBaseDamage *= ARROW_DAMAGE`
*   **速度**: `DeltaMovement *= ARROW_VELOCITY`

**注意**: 这是一个一次性的修改，箭矢射出后的属性即被固化。

### 2.4 投射物全域增伤
**事件**: `LivingIncomingDamageEvent` (Priority: HIGHEST)
**方法**: `projDmg`

如果伤害源是投射物 (Projectile)，直接将最终伤害乘以攻击者的 `PROJECTILE_DAMAGE` 属性。

---

## 3. 防御与回复机制 (Defensive & Utility)

### 3.1 闪避 (Dodge)
**事件**: `LivingIncomingDamageEvent` (近战) / `ProjectileImpactEvent` (远程)
**方法**: `dodge`

*   **触发条件**:
    *   近战: 攻击者在近战攻击范围内。
    *   远程: 投射物击中实体。
*   **RNG 种子同步机制**:
    为了防止同一 tick 内的多段伤害判定出现“部分闪避”的情况，闪避的随机数种子是固定的：
    ```java
    seed = target.tickCount + target.getUUID().hashCode() + magic_constants
    ```
    这意味着在同一个 tick 内，目标要么闪避所有攻击，要么全部命中。
*   **效果**: 取消事件 (伤害为 0)，播放音效，生成大烟雾粒子。

### 3.2 吸血与过量治疗
**事件**: `LivingDamageEvent.Post`
**方法**: `lifeStealOverheal`

*   **吸血 (`LIFE_STEAL`)**:
    *   逻辑: `attacker.heal(damage_dealt * LIFE_STEAL)`。
    *   限制: 只有物理伤害触发，且伤害值取 `min(damage, target_pre_hit_health)`（防止鞭尸刷血）。
*   **过量治疗 (`OVERHEAL`)**:
    *   逻辑: 当满血时，将溢出的吸血量或治疗量转化为伤害吸收 (Absorption)。
    *   上限: 最大伤害吸收量为 `MaxHealth * 50%`。
    *   实现: 使用 `LEInvoker` 绕过原版对伤害吸收的自然衰减或上限检查。

### 3.3 治疗加成
**事件**: `LivingHealEvent`
**方法**: `heal`

*   直接将治疗量乘以 `HEALING_RECEIVED`。如果结果 <= 0，则取消治疗事件。

### 3.4 蓄力速度 (Draw Speed)
**事件**: `LivingEntityUseItemEvent.Tick`
**方法**: `drawSpeed`

用于加速弓、弩或三叉戟的使用。
*   **原理**: 修改 `useItem` 的 `duration`，变相让物品“每 tick 使用了多次”。
*   **公式**:
    设 `t = DRAW_SPEED - 1`。
    1.  **整数部分**: 每 `1.0` 的速度，`duration + 1` (即每 tick 计算 2 次使用)。
    2.  **0.5 阈值**: 如果剩余小数 `> 0.5`，每偶数 tick `duration + 1`。
    3.  **微量部分**: 剩余部分按照 `1/t` 的周期进行加速。
*   **负值处理**: 如果速度 < 1.0 (减速)，则反向操作，延长蓄力时间。

---

## 4. 杂项机制

### 4.1 经验获取
**事件**: `BlockDropsEvent`, `LivingExperienceDropEvent`
**逻辑**: 将掉落的经验球数值直接乘以 `EXPERIENCE_GAINED`。

### 4.2 挖掘速度
**事件**: `BreakSpeed`
**逻辑**: `NewSpeed = OriginalSpeed * MINING_SPEED`。

### 4.3 攻击范围显示 (Client/Tooltip related)
**事件**: `ItemAttributeModifierEvent` (Priority: LOW)
**逻辑**:
代码中有一个 Hack (`affixModifiers`)：如果物品有基础攻击伤害 (Attack Damage) 但没有基础攻击距离 (Entity Reach)，它会手动添加一个值为 0 的 `ENTITY_INTERACTION_RANGE` 修饰符。
*   **目的**: 强迫客户端在 Tooltip 中显示攻击距离属性，而不改变实际数值。

### 4.4 鞘翅飞行
**事件**: `ItemAttributeModifierEvent`
**逻辑**: 如果物品是 `ElytraItem` 且没有飞行属性，自动添加 `ELYTRA_FLIGHT` 属性修饰符。

## 5. 数据附件 (Attachments)

模组使用了 NeoForge 的 `DataAttachment` 系统来存储临时数据：

*   `PRE_DAMAGE_HEALTH`: 记录受伤前的生命值，用于计算吸血上限。
*   `AUX_DMG_TRACKER`: 辅助伤害追踪器，用于处理附带魔法伤害。
*   `apothic_attributes.arrow.done` (Tag): 防止箭矢重复应用属性加成。
*   `apoth.killed_by_aux_dmg` (Tag): 标记实体死于辅助伤害。

这份文档是基于你提供的源码生成的**开发者级**机制详解。它不关注“这个道具有什么用”，而是关注“代码如何通过 Attribute、DataComponent 和 Mixin 实现这些功能”。

---

# Artifacts Mod 核心机制架构文档

## 1. 属性系统 (Attribute System)

Mod 的核心数值逻辑基于 Minecraft 原生的 `Attribute` 系统，分为 **静态属性** 和 **动态属性**。

### 1.1 自定义属性注册 (`ModAttributes`)
所有属性注册在 `Registries.ATTRIBUTE` 下。
*   **Player Attributes (玩家专用):** 仅注入到 `Player` 实体。
    *   `player.entity_experience`: 经验倍率 (Mixin: `ArtifactHooks.modifyExperience`)。
    *   `player.villager_reputation`: 村民声望加成 (Mixin: `VillagerMixin` 在计算价格时直接相加)。
*   **Generic Attributes (通用):** 注入到所有 `LivingEntity`。
    *   `generic.invincibility_ticks`: 受伤后的无敌帧增量。
    *   `generic.drinking/eating_speed`: 使用物品的速率除数。
    *   `generic.flatulence`: 潜行时放屁的概率 (0.0 - 1.0)。
    *   `generic.attack_burning_duration`: 攻击附带火焰秒数。

### 1.2 动态属性修饰符 (`DynamicAttributeModifier`)
这是一个高级机制，用于根据实体**当前状态**（State）实时调整属性值，而不是永久固定的数值。

**工作原理 (`DynamicAttributeModifier.java`):**
1.  **Tick 检测:** 在 `ArtifactHooks.livingUpdate` 中每 tick 调用 `tickModifiers(entity)`。
2.  **条件判断:** 检查实体状态（如 `isSprinting()`, `getControllingPassenger()`）。
3.  **瞬态修饰 (Transient Modifier):**
    *   如果满足条件：计算数值并添加/更新一个 `TransientModifier` (UUID 固定)。
    *   如果不满足条件：移除该 Modifier。

**应用实例:**
*   **`SPRINTING_SPEED` (跑鞋):** 只有当 `entity.isSprinting()` 为真时，才将 `running_shoes` 的属性值应用到 `MOVEMENT_SPEED` 上。
*   **`MOVEMENT_SPEED_ON_SNOW` (雪鞋):** 检测脚下或脚下下方的方块 Tag (`BlockTags.SNOW` / `SNOW_LAYERS`)，如果在雪上则应用速度修正。
*   **`MOUNT_SPEED` (牛仔帽):** 检测 `entity.getControllingPassenger()`，将乘客的 `MOUNT_SPEED` 属性应用到坐骑的移动速度上。

---

## 2. 物品组件与能力系统 (Item Components & Abilities)

物品不再直接硬编码逻辑，而是通过 **Data Components (`ModDataComponents`)** 携带能力 (`Ability`)。

### 2.1 能力挂载 (`ModItems`)
物品在注册时绑定组件。例如 `PLASTIC_DRINKING_HAT`：
```java
builder.addAttributeModifier(ModAttributes.DRINKING_SPEED, ...);
```
这实际上是将一个 `AttributeModifiers` 组件写入 ItemStack。

### 2.2 装备更新逻辑 (`ArtifactHooks.onItemChanged`)
当物品栏发生变化时：
1.  **Diff Check:** 比较旧物品和新物品的组件。
2.  **Toggle Logic:** 检查 `DISABLED_BY_TOGGLE` 组件（用户是否禁用了该功能）。
3.  **Refresh:** 调用 `refreshTickingAbilities(entity)`。该方法会遍历装备栏，设置一个布尔标记 `artifacts$setTickingAbilities`，决定该实体是否需要在每 tick 执行逻辑，优化性能。

### 2.3 属性应用逻辑 (`AttributeModifiers.Entry`)
不同于原生的 `ItemAttributeModifier` (它只在装备槽位本身处理)，Artifacts 使用自定义逻辑：
*   **Worn Tick:** 在 `onItemTick` 中，组件会检查 `AttributeInstance`。
*   **如果未禁用:** 添加一个 `PermanentModifier`。
*   **如果处于冷却 (Cooldown):** 对于非装饰性属性，如果物品在冷却中（如 `player.getCooldowns()`），则临时移除该 Attribute Modifier。

---

## 3. 事件钩子与逻辑流 (Event Hooks & Logic Flow)

`ArtifactHooks` 是连接 Minecraft 事件总线和 Mod 逻辑的桥梁。

### 3.1 伤害流程 (`onLivingDamaged` & `doPostAttackEffects`)
当实体受伤或攻击时，执行顺序如下：
1.  **伤害吸收 (`absorbDamage`):**
    *   遍历攻击者的 `DAMAGE_ABSORPTION` 组件（如吸血手套）。
    *   计算 `Math.min(max_absorb, ratio * damage)`。
    *   执行 `attacker.heal()`。
2.  **受击后效果 (`PostDamageEffects`):**
    *   遍历受害者的组件（如 `PANIC_NECKLACE`）。
    *   触发效果（如给予速度 Buff）。
3.  **受击冷却 (`PostDamageCooldown`):**
    *   触发物品冷却（如 `CROSS_NECKLACE` 触发后进入 CD）。
4.  **反伤/攻击特效 (`doPostAttackEffects`):**
    *   **反伤 (`RetaliationEffects`):** 荆棘吊坠、火焰吊坠等触发反击。
    *   **攻击燃烧 (`onAttackBurningLivingHurt`):** 读取攻击者的 `ATTACK_BURNING_DURATION` 属性，调用 `entity.igniteForSeconds()`。

### 3.2 实体更新 (`livingUpdate`)
1.  **游泳数据更新:** 处理 `SwimData` (用于脚蹼等)。
2.  **物品 Tick (`onItemTick`):**
    *   遍历所有 `TickingAbility` 组件。
    *   执行 `ability.wornTick()`。
3.  **动态属性 Tick:** 更新上文提到的 `DynamicAttributeModifier`。
4.  **雨伞逻辑:** 如果在空中，执行 `UmbrellaItem.onLivingUpdate` (修改重力)。

### 3.3 特殊交互
*   **自动熔炼 (`applySmeltOresAbility`):**
    *   Hook 挖掘掉落逻辑。
    *   查询 `RecipeType.SMELTING`。
    *   如果存在配方，直接返回产物并给予经验。
*   **使用时间 (`modifyUseDuration`):**
    *   根据 `UseAnim` (吃/喝) 分别除以 `EATING_SPEED` 或 `DRINKING_SPEED` 属性。

---

## 4. 关键 Mixin 注入分析

为了实现某些无法通过事件完成的功能，使用了 Mixin 修改底层逻辑。

### 4.1 无敌帧修改 (`LivingEntityMixin`)
*   **目标:** `invulnerableTime` 字段。
*   **注入点:** 字段写入后 (PUTFIELD)。
*   **逻辑:** `entity.invulnerableTime += entity.getAttributeValue(ModAttributes.INVINCIBILITY_TICKS)`。
*   **结果:** 十字架项链通过增加属性值，直接延长了无敌时间。

### 4.2 放屁机制 (`EntityMixin`)
*   **目标:** `setShiftKeyDown`。
*   **逻辑:** 当玩家按下 Shift 且当前未处于 Shift 状态时：
    *   获取 `generic.flatulence` 属性值（概率）。
    *   `Random` 判定是否触发声音和 GameEvent。

### 4.3 属性注入 (`PlayerMixin` / `LivingEntityMixin`)
*   **目标:** `createAttributes` / `createLivingAttributes`。
*   **逻辑:** 确保 `ModAttributes` 定义的 Holder 被注册到实体上，否则调用 `getAttribute` 会返回 Null。

---

## 5. 特定物品机制详解

### 5.1 二段跳 (Cloud in a Bottle) - `DoubleJump.java`
这是一个纯逻辑组件，不仅是属性。
*   **触发:** 监听 `InputEvent` (客户端) -> 发包 -> 服务端执行 `DoubleJump.jump(player)`。
*   **物理计算:**
    *   重置 `fallDistance = 0`。
    *   **垂直速度:** `0.5 + 0.1 * JumpBoostLevel`。
    *   **水平速度:** 如果冲刺，根据 `sprintHorizontalVelocity` 分量计算 `sin/cos` 增量。
*   **副作用:** 消耗饱食度 (`causeFoodExhaustion`)，播放音效。

### 5.2 也是二段跳的兔子脚 (Bunny Hoppers)
*   不同于瓶中云，它使用 **Attribute**。
*   `JUMP_STRENGTH` (跳跃力度) 和 `SAFE_FALL_DISTANCE` (安全掉落距离) 是原版属性，Artifacts 只是修饰了数值。

### 5.3 磁铁 (Universal Attractor)
*   **实现:** 这是一个 `MobEffect` (`ModMobEffects.MAGNETISM`) 而不是直接的物品逻辑。
*   物品 `wornTick` 只是不断地给玩家刷新这个 Buff。
*   Buff 的逻辑负责吸取掉落物。

### 5.4 踏冰鞋 (Snowshoes)
*   **实现:** 混合了 `DynamicAttributeModifier` 和 `DataComponent`。
*   **速度:** 动态属性检测方块 Tag 增加移动速度。
*   **防陷:** `ModDataComponents.WALK_ON_POWDER_SNOW` 被注入到细雪方块的碰撞箱逻辑中 (通常通过 Mixin `PowderSnowBlock` 实现，虽然这段代码没展示，但逻辑是 `EquipmentHelper.hasAbilityActive` 检测)。

这是一个基于你提供的代码片段生成的 **Iron's Spells 'n Book (ISB) 核心机制开发者文档**。

这份文档旨在从**代码逻辑**和**API交互**的角度，解释法术冷却、法力值管理、伤害处理及召唤物行为的底层机制。

---

# Iron's Spells 'n Books 核心机制文档 (Developer Edition)

## 1. 冷却缩减机制 (Cooldown Reduction)

冷却计算并未采用简单的线性百分比扣除，而是引入了**软上限 (Soft Cap)** 机制，防止冷却时间缩减过多导致平衡崩坏（如无限施法）。

### 核心逻辑
位于 `MagicData` 或相关工具类中：
*   **方法**: `applyCooldownReduction(int baseTicks, @Nullable LivingEntity livingEntity)`
*   **输入**: 基础冷却 tick 数 (`baseTicks`)，施法实体 (`livingEntity`)。
*   **属性**: 依赖实体属性 `COOLDOWN_REDUCTION`。如果实体为 `null`，倍率默认为 `1`。

### 数学公式
最终冷却 Ticks = `(int) (baseTicks * (2 - softCapFormula(modifier)))`

**软上限公式 (`softCapFormula`)**:
设输入修饰符为 $x$ (即玩家的 `COOLDOWN_REDUCTION` 属性值)：

1.  **线性阶段 ($x \le 1.5$)**:
    *   $$f(x) = x$$
    *   **效果**: 在属性值达到 1.5（即 50% 冷却缩减效果）之前，收益是线性的。
    *   例如：属性为 1.2 (20% CDR)，计算为 $2 - 1.2 = 0.8$ 倍率。

2.  **递减阶段 ($x > 1.5$)**:
    *   $$f(x) = -0.25 \times \frac{1}{x - 1} + 2$$
    *   **效果**: 这是一个双曲线函数，随着 $x$ 增加，其返回值无限趋近于 2，但永远不会达到 2。这意味着 `2 - f(x)` 永远不会等于 0。
    *   **目的**: 即使堆叠极高的冷却缩减属性，法术冷却时间也永远不会变为 0 tick。

---

## 2. 法力值系统 (Mana System)

法力值的变更并不是直接赋值，而是通过事件总线进行封装，允许第三方 Mod 干预。

### 变更流程 (`setMana`)
1.  **构建事件**: 创建 `ChangeManaEvent` 实例，包含当前 ServerPlayer、MagicData、旧法力值 (`oldMana`) 和目标新法力值 (`newMana`)。
2.  **触发事件**: 在 `NeoForge.EVENT_BUS` 上发布事件。
    *   **Cancellable**: 如果事件被取消，法力值**不会**改变。
    *   **修改权**: 其他监听器可以通过 `event.setNewMana(float)` 修改最终设定的法力值。
3.  **赋值与截断**:
    *   如果事件未取消，将 `this.mana` 更新为 `event.getNewMana()`。
    *   **上限检查**: 再次检查 `this.mana` 是否超过玩家属性 `AttributeRegistry.MAX_MANA`。如果超过，强制拉回最大值。

### API: `ChangeManaEvent`
*   **父类**: `PlayerEvent` (提供 `getPlayer()`)。
*   **接口**: `ICancellableEvent`。
*   **字段**: `magicData`, `oldMana`, `newMana`。
*   **用途**: 用于实现“无限蓝量”、“禁止回蓝”或“蓝量护盾”等机制。

---

## 3. 法术伤害系统 (Spell Damage System)

ISB 使用自定义的伤害源 `SpellDamageSource` 来携带法术特有的元数据，并在攻击判定前通过事件进行拦截处理。

### 伤害源 (`SpellDamageSource`)
继承自原版 `DamageSource`，扩展了以下功能：
*   **关联法术**: 只有 `SpellDamageSource` 知道是哪个 `AbstractSpell` 造成了伤害。
*   **特效参数**:
    *   `lifesteal`: 吸血百分比。
    *   `freezeTicks`: 冻结时长。
    *   `fireTime`: 点燃时长。
    *   `iFrames`: **无敌帧覆盖** (核心机制)。
*   **死亡信息**: 重写 `getLocalizedDeathMessage`，格式为 `death.attack.<spell_id>`，支持显示施法者或直接实体（如投射物）。

### 伤害处理逻辑 (`preHitEffects`)
监听 `LivingIncomingDamageEvent`，在伤害实际结算前触发：

1.  **无敌帧 (IFrames) 重写**:
    *   如果伤害源是 `SpellDamageSource` 且 `iFrames >= 0`。
    *   **操作**: 强制修改受击目标的 `postAttackInvulnerabilityTicks`。这允许某些高频法术（如持续射线）忽略原版 Minecraft 的 0.5秒无敌时间，或者某些重击法术给予更长的无敌时间。

2.  **召唤物伤害修正**:
    *   检测伤害来源是否为 `IMagicSummon`（召唤物）。
    *   **防误伤机制**: 如果 `summoner.UUID` == `target.UUID`，**取消事件**。召唤物无法伤害其主人。
    *   **属性继承**: 如果召唤者是 `LivingEntity`，伤害会乘以召唤者的 `AttributeRegistry.SUMMON_DAMAGE` 属性。
        *   *这意味着召唤物的输出强度取决于主人的属性，而非召唤物自身的面板。*

---

## 4. 召唤物系统 (Summoning System)

所有魔法召唤物必须实现 `IMagicSummon` 接口，该接口定义了召唤物的生命周期、归属权及反魔法交互。

### 核心接口 `IMagicSummon`

#### 1. 归属权 (Ownership)
*   **获取主人**: `getSummoner()` 委托给 `SummonManager.getOwner(this)`。
*   **同盟判定 (`isAlliedHelper`)**:
    *   判断两个实体是否为盟友。
    *   支持递归检查：如果目标也是 `IMagicSummon` 或 `OwnableEntity` (如驯服的狼)，则比较双方的主人是否相同或结盟。

#### 2. 伤害豁免 (`shouldIgnoreDamage`)
召唤物在以下情况豁免伤害：
*   伤害不属于 `BYPASSES_INVULNERABILITY` (如虚空伤害)。
*   配置项 `ServerConfigs.CAN_ATTACK_OWN_SUMMONS` 为 `false`。
*   伤害来源与召唤物被判定为“友军火误伤” (`DamageSources.isFriendlyFireBetween`)。

#### 3. 生命周期与销毁
*   **反魔法 (`onAntiMagic`)**: 默认行为是直接调用 `onUnSummon()`（通常导致消失）。
*   **死亡处理 (`onDeathHelper`)**:
    *   如果在服务端且 `ShowDeathMessages` 规则开启，会向主人 (`ServerPlayer`) 发送召唤物的死亡消息。
*   **移除处理 (`onRemovedHelper`)**:
    *   **Discarded**: 当实体被丢弃（despawn）时，向主人发送消息 `ui.irons_spellbooks.summon_despawn_message`。
    *   **清理**: 从 `SummonManager` 中移除该实体引用，停止追踪过期时间。
    *   *开发者注*: 旧版代码中通过 MobEffect (药水效果) 来追踪召唤物数量的逻辑已被标记为 `@Deprecated`，现在的逻辑更加独立。

### 实体数据访问 (Mixin)
代码片段中出现了 `((EntityAccessor) entity).setRemovalReason(...)`。
*   这表明 ISB 使用了 Mixin 来访问原版 `Entity` 类的受保护字段（如 `removalReason`），以便在某些边缘情况下（如强制卸载区块）控制召唤物的销毁流程。

---

## 总结：给开发者的集成建议

1.  **修改法力值**: 不要直接操作 `magicData.mana`，使用 `setMana()` 确保触发事件，或者监听 `ChangeManaEvent` 来实现你的自定义逻辑。
2.  **自定义法术伤害**: 务必使用 `SpellDamageSource`。如果你希望你的法术每 tick 造成伤害且不被原版无敌帧卡住，请设置 `.setIFrames(0)`。
3.  **召唤物AI**: 如果你正在编写自定义召唤物，实现 `IMagicSummon` 接口能自动获得“防误伤”、“伤害受主人属性加成”和“反魔法易伤”等特性。
4.  **冷却平衡**: 在设计装备或Buff时，无需担心溢出，软上限公式会自动处理平衡。属性值 1.5 (即 +50% CDR) 是收益递减的分界线。
